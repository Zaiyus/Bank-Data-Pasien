<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Data Pasien | Advanced Dashboard Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS: Tampilan Canggih, Glassmorphism Ringan, dan Animasi */
        :root {
            --primary-color: #00796B; /* Teal/Biru-Hijau Fresh */
            --secondary-color: #37474F; /* Abu-abu Tua Elegan */
            --accent-color: #26C6DA; /* Cyan Terang */
            --danger-color: #E53935; /* Merah untuk Indikator Sakit */
            --success-color: #4CAF50; /* Hijau untuk Indikator Sehat */
            --background-dark: #ECEFF1; /* Latar belakang sangat terang */
            --card-background: rgba(255, 255, 255, 0.8); /* Glassmorphism ringan */
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --text-color: #212121;
            --font-family: 'Poppins', sans-serif;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-color);
            transition: background-color 0.3s ease;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* --- Glassmorphism Card Style --- */
        .card {
            background: var(--card-background);
            border-radius: 16px;
            box-shadow: var(--shadow-light);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: var(--glass-border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        .card-header i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }

        .main-container {
            flex-grow: 1;
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }

        /* Layout untuk Desktop/Tablet */
        @media (min-width: 768px) {
            .main-container {
                grid-template-columns: 1fr 2fr;
            }
            #filter-section {
                order: 1;
            }
            #chart-section {
                order: 2;
                grid-column: span 1 / auto;
            }
            #table-section {
                order: 3;
                grid-column: span 2 / auto;
            }
        }

        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 1.5fr 3fr;
            }
            #chart-section {
                grid-column: span 1 / auto;
            }
        }


        /* --- Filter Section --- */
        .filter-group {
            margin-bottom: 1rem;
        }
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: var(--secondary-color);
        }
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: white;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .filter-group select:focus, .filter-group input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(38, 198, 218, 0.2);
            outline: none;
        }

        #reset-button {
            background-color: var(--danger-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s;
            width: 100%;
            font-weight: 600;
            margin-top: 1.5rem;
        }
        #reset-button:hover {
            background-color: #C62828;
            transform: translateY(-2px);
        }

        /* --- Chart Section --- */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .chart-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .chart-container {
            position: relative;
            height: 300px;
        }


        /* --- Table Section --- */
        #data-table-container {
            overflow-x: auto;
            max-height: 60vh; /* Membatasi tinggi agar bisa di-scroll */
            overflow-y: auto;
            border-radius: 12px;
        }

        #patient-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px; /* Minimal lebar tabel untuk mobile */
        }

        #patient-table th, #patient-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #CFD8DC; /* Garis pemisah ringan */
        }

        #patient-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky; /* Sticky header */
            top: 0;
            z-index: 10;
        }

        #patient-table tbody tr {
            background-color: white;
            transition: background-color 0.2s ease;
        }

        #patient-table tbody tr:hover {
            background-color: #E0F2F1; /* Hover effect */
        }

        /* Status Styling */
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-Sehat {
            background-color: var(--success-color);
            color: white;
        }

        .status-Sakit {
            background-color: var(--danger-color);
            color: white;
        }

        /* Responsive Utility for small text */
        @media (max-width: 600px) {
            body {
                font-size: 0.9rem;
            }
            .card {
                padding: 1rem;
            }
            header h1 {
                font-size: 1.2rem;
            }
            #patient-table th, #patient-table td {
                padding: 8px 10px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
</head>
<body>
    <header>
        <h1><i class="fas fa-stethoscope"></i> Bank Data Pasien</h1>
        <div>Advanced Dashboard Final</div>
    </header>

    <main class="main-container">
        <!-- Filter Section -->
        <section id="filter-section" class="card">
            <h2 class="card-header"><i class="fas fa-filter"></i> Filter Data</h2>

            <div class="filter-group">
                <label for="filter-gender">Jenis Kelamin:</label>
                <select id="filter-gender" onchange="filterTable(); renderCharts();">
                    <option value="">Semua</option>
                    <!-- Options akan diisi oleh JS -->
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-condition">Kondisi:</label>
                <select id="filter-condition" onchange="filterTable(); renderCharts();">
                    <option value="">Semua</option>
                    <!-- Options akan diisi oleh JS -->
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-city">Kota:</label>
                <select id="filter-city" onchange="filterTable(); renderCharts();">
                    <option value="">Semua</option>
                    <!-- Options akan diisi oleh JS -->
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-age">Usia (Min):</label>
                <input type="number" id="filter-age" min="0" placeholder="Minimal Usia" onkeyup="filterTable(); renderCharts();">
            </div>

            <button id="reset-button" onclick="resetFilters()">
                <i class="fas fa-redo"></i> Reset Filter
            </button>
        </section>

        <!-- Chart Section -->
        <section id="chart-section" class="card">
            <h2 class="card-header"><i class="fas fa-chart-bar"></i> Visualisasi Data</h2>
            <div class="chart-grid">
                <div class="chart-item">
                    <label>Pasien Berdasarkan Kondisi</label>
                    <div class="chart-container">
                        <canvas id="conditionChart"></canvas>
                    </div>
                </div>
                <div class="chart-item">
                    <label>Pasien Berdasarkan Jenis Kelamin</label>
                    <div class="chart-container">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Table Section -->
        <section id="table-section" class="card">
            <h2 class="card-header"><i class="fas fa-table"></i> Data Pasien (Tersaring)</h2>
            <div id="data-table-container">
                <table id="patient-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Usia</th>
                            <th>J. Kelamin</th>
                            <th>Kota</th>
                            <th>Kondisi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data akan diisi oleh JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script type="module">
        // Import modul Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, getDocs, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global untuk data dan koneksi Firebase
        let patientData = [];
        let filteredData = [];
        let db;
        let auth;
        let userId;

        // Data Dummy untuk inisialisasi awal di Firestore jika koleksi kosong
        const initialDummyPatients = [
            { name: "Ahmad Rizky", age: 35, gender: "Laki-laki", city: "Jakarta", condition: "Sakit" },
            { name: "Bunga Citra", age: 22, gender: "Perempuan", city: "Bandung", condition: "Sehat" },
            { name: "Candra Dewi", age: 50, gender: "Perempuan", city: "Surabaya", condition: "Sakit" },
            { name: "Deni Saputra", age: 62, gender: "Laki-laki", city: "Jakarta", condition: "Sehat" },
            { name: "Eka Prawira", age: 19, gender: "Laki-laki", city: "Yogyakarta", condition: "Sakit" },
            { name: "Fitriani", age: 41, gender: "Perempuan", city: "Bandung", condition: "Sehat" },
            { name: "Gilang Ramadhan", age: 28, gender: "Laki-laki", city: "Semarang", condition: "Sakit" },
            { name: "Hana Silvia", age: 33, gender: "Perempuan", city: "Jakarta", condition: "Sehat" },
            { name: "Irfan Maulana", age: 75, gender: "Laki-laki", city: "Surabaya", condition: "Sakit" },
            { name: "Juwita Sari", age: 48, gender: "Perempuan", city: "Yogyakarta", condition: "Sehat" },
            { name: "Kusuma Jaya", age: 25, gender: "Laki-laki", city: "Bandung", condition: "Sakit" },
            { name: "Lina Marlina", age: 55, gender: "Perempuan", city: "Jakarta", condition: "Sakit" },
            { name: "Mirza Hidayat", age: 17, gender: "Laki-laki", city: "Semarang", condition: "Sehat" },
            { name: "Nadia Utami", age: 30, gender: "Perempuan", city: "Jakarta", condition: "Sakit" },
            { name: "Oscar Wibowo", age: 68, gender: "Laki-laki", city: "Surabaya", condition: "Sehat" },
        ];


        // Fungsi untuk memastikan data awal ada di Firestore
        async function ensureInitialDataExists(appId) {
            const patientCollectionPath = `/artifacts/${appId}/public/data/patients`;
            const patientColRef = collection(db, patientCollectionPath);
            
            try {
                // Cek apakah koleksi sudah ada data
                const snapshot = await getDocs(patientColRef);
                if (snapshot.empty) {
                    console.log("Collection is empty. Adding initial dummy data.");
                    // Tambahkan data dummy ke Firestore
                    for (const patient of initialDummyPatients) {
                        await addDoc(patientColRef, patient);
                    }
                    console.log("Initial dummy data added.");
                } else {
                    console.log("Collection already contains data.");
                }
            } catch (error) {
                console.error("Error ensuring initial data:", error);
            }
        }

        // Fungsi untuk mengambil data secara real-time dari Firestore
        function setupPatientDataListener(appId) {
            const patientCollectionPath = `/artifacts/${appId}/public/data/patients`;
            const patientColRef = collection(db, patientCollectionPath);

            // Gunakan onSnapshot untuk real-time updates
            onSnapshot(patientColRef, (snapshot) => {
                patientData = [];
                snapshot.forEach((doc) => {
                    // ID dokumen Firestore digunakan sebagai ID pasien
                    patientData.push({ id: doc.id, ...doc.data() });
                });

                // Setelah data diperbarui, render ulang semuanya
                populateFilters();
                filterTable(); // Memanggil filterTable juga akan memanggil renderCharts
                console.log(`Loaded ${patientData.length} patient records in real-time.`);
            }, (error) => {
                console.error("Firestore Listener Error:", error);
            });
        }


        // Fungsi untuk inisialisasi Firebase dan memuat data
        async function initializeFirebaseAndLoadData() {
            console.log("Initializing Firebase...");
            // Set Firebase Debug Log Level
            setLogLevel('debug');

            // 1. Ambil Config dari Lingkungan Canvas (Wajib)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

            // Fallback config menggunakan data dari prompt jika global config tidak tersedia
            const userProvidedConfig = {
                 apiKey: "AIzaSyBttm1j4cKQn-TZgHZBxbFrmqx09hgFgUE",
                 authDomain: "bank-data-pasien-pkm-mdh.firebaseapp.com",
                 projectId: "bank-data-pasien-pkm-mdh",
                 storageBucket: "bank-data-pasien-pkm-mdh.firebasestorage.app",
                 messagingSenderId: "835248495447",
                 appId: "1:835248495447:web:2ea210e25e817ff85d7c12",
                 measurementId: "G-CWX1KGNNRS"
            };
            
            const firebaseConfig = JSON.parse(firebaseConfigString || JSON.stringify(userProvidedConfig));


            // 2. Inisialisasi Firebase
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 3. Autentikasi
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
                userId = auth.currentUser?.uid || crypto.randomUUID(); // Dapatkan atau buat ID pengguna
                
                // 4. Inisialisasi Listener Data dan pastikan data awal ada
                await ensureInitialDataExists(appId);
                setupPatientDataListener(appId);


            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }


        // Fungsi untuk mengisi pilihan filter secara dinamis
        function populateFilters() {
            // Kita tidak bisa menjamin semua field ada, jadi perlu pengecekan
            const getUniqueValues = (field) => [...new Set(patientData.map(p => p[field]).filter(Boolean))].sort();

            const genders = getUniqueValues('gender');
            const conditions = getUniqueValues('condition');
            const cities = getUniqueValues('city');

            const createOptions = (selectId, values) => {
                const select = document.getElementById(selectId);
                // Pertahankan opsi "Semua"
                const currentValue = select.value;
                select.innerHTML = '<option value="">Semua</option>';
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
                // Kembalikan nilai yang dipilih jika masih ada
                if (values.includes(currentValue)) {
                    select.value = currentValue;
                }
            };

            createOptions('filter-gender', genders);
            createOptions('filter-condition', conditions);
            createOptions('filter-city', cities);
        }

        // Fungsi untuk menyaring data dan me-render tabel
        function filterTable() {
            const gender = document.getElementById('filter-gender').value;
            const condition = document.getElementById('filter-condition').value;
            const city = document.getElementById('filter-city').value;
            const minAge = parseInt(document.getElementById('filter-age').value) || 0;

            filteredData = patientData.filter(p => {
                const isGenderMatch = !gender || p.gender === gender;
                const isConditionMatch = !condition || p.condition === condition;
                const isCityMatch = !city || p.city === city;
                const isAgeMatch = (p.age !== undefined && p.age !== null) ? p.age >= minAge : true; // Anggap benar jika usia tidak ada

                return isGenderMatch && isConditionMatch && isCityMatch && isAgeMatch;
            });

            renderTable(filteredData);
            renderCharts(); // Panggil renderCharts di sini agar visualisasi update setelah filter
        }

        // Fungsi untuk merender data di tabel
        function renderTable(data) {
            const tableBody = document.getElementById('patient-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            if (data.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.textContent = "Tidak ada data pasien yang sesuai dengan filter.";
                cell.style.textAlign = 'center';
                cell.style.padding = '20px';
                return;
            }

            data.forEach(p => {
                const row = tableBody.insertRow();
                // Menggunakan ID dokumen Firestore, yang merupakan string unik
                row.insertCell().textContent = p.id.substring(0, 6) + '...'; 
                row.insertCell().textContent = p.name || 'N/A';
                row.insertCell().textContent = p.age || 'N/A';
                row.insertCell().textContent = p.gender || 'N/A';
                row.insertCell().textContent = p.city || 'N/A';

                const conditionCell = row.insertCell();
                const condition = p.condition || 'N/A';
                const statusClass = condition.replace(/[^a-zA-Z0-9]/g, ''); // Membersihkan string untuk kelas CSS
                
                if (condition === 'N/A') {
                    conditionCell.textContent = condition;
                } else {
                    conditionCell.innerHTML = `<span class="status-badge status-${statusClass}">${condition}</span>`;
                }
            });
        }

        // Fungsi untuk mereset semua filter
        function resetFilters() {
            document.getElementById('filter-gender').value = "";
            document.getElementById('filter-condition').value = "";
            document.getElementById('filter-city').value = "";
            document.getElementById('filter-age').value = "";
            filterTable();
        }

        // Fungsi untuk merender Chart.js
        let conditionChartInstance = null;
        let genderChartInstance = null;

        function renderCharts() {
            // 1. Data Kondisi
            const conditionCounts = filteredData.reduce((acc, p) => {
                const condition = p.condition || 'Tidak Diketahui';
                acc[condition] = (acc[condition] || 0) + 1;
                return acc;
            }, {});

            const conditionLabels = Object.keys(conditionCounts);
            const conditionData = Object.values(conditionCounts);
            // Tetapkan warna berdasarkan label (jika ada) atau default
            const conditionColors = conditionLabels.map(label => {
                if (label === 'Sakit') return varToHex('--danger-color');
                if (label === 'Sehat') return varToHex('--success-color');
                return '#757575'; // Warna abu-abu untuk 'Tidak Diketahui'
            });

            if (conditionChartInstance) {
                conditionChartInstance.destroy();
            }
            conditionChartInstance = createDoughnutChart('conditionChart', conditionLabels, conditionData, conditionColors);

            // 2. Data Jenis Kelamin
            const genderCounts = filteredData.reduce((acc, p) => {
                const gender = p.gender || 'Tidak Diketahui';
                acc[gender] = (acc[gender] || 0) + 1;
                return acc;
            }, {});

            const genderLabels = Object.keys(genderCounts);
            const genderData = Object.values(genderCounts);
            const genderColors = [varToHex('--primary-color'), varToHex('--accent-color'), '#757575']; // Contoh warna

            if (genderChartInstance) {
                genderChartInstance.destroy();
            }
            genderChartInstance = createDoughnutChart('genderChart', genderLabels, genderData, genderColors);
        }

        // Utility untuk konversi CSS variable ke nilai Hex
        function varToHex(variable) {
            const rootStyle = getComputedStyle(document.documentElement);
            const colorValue = rootStyle.getPropertyValue(variable).trim();
            if (colorValue.startsWith('rgba(')) {
                const parts = colorValue.match(/rgba\((\d+), (\d+), (\d+), ([\d.]+)\)/);
                if (parts) {
                    const r = parseInt(parts[1]).toString(16).padStart(2, '0');
                    const g = parseInt(parts[2]).toString(16).padStart(2, '0');
                    const b = parseInt(parts[3]).toString(16).padStart(2, '0');
                    return `#${r}${g}${b}`;
                }
            }
            return colorValue;
        }


        // Fungsi pembantu untuk membuat chart Doughnut
        function createDoughnutChart(canvasId, labels, data, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chartData = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    hoverOffset: 4,
                    borderColor: 'white',
                    borderWidth: 2
                }]
            };

            return new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%';
                                    return label + ' (' + percentage + ')';
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseAndLoadData();
            // initializeFirebaseAndLoadData akan memanggil filterTable dan renderCharts setelah data dimuat
        });
    </script>
</body>
</html>
